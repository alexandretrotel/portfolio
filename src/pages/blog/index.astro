---
import { getCollection } from "astro:content";
import { getTranslations } from "@/i18n/translations";
import { formatDate, formatNumber } from "@/i18n/utils";
import Layout from "@/layouts/layout.astro";
import { redis } from "@/lib/redis";
import { cn } from "@/lib/utils";

const t = getTranslations("en");

let posts: Awaited<ReturnType<typeof getCollection<"blog-en">>> = [];
try {
  posts = await getCollection("blog-en");
} catch {
  posts = [];
}

async function getViewCount(slug: string): Promise<number> {
  if (!redis) {
    return 0;
  }
  try {
    const views = await redis.get(`pageviews:${slug}`);
    return typeof views === "number" ? views : 0;
  } catch {
    return 0;
  }
}

// Sort by date (newest first) and add view counts
const sortedPosts = posts.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);

const enhancedPosts = await Promise.all(
  sortedPosts.map(async (post, index, arr) => {
    const views = await getViewCount(post.slug);
    const formattedDateStr = formatDate(post.data.date, "en");

    const showDate =
      index === 0 ||
      index === arr.length - 1 ||
      (arr[index + 1] &&
        formattedDateStr !== formatDate(arr[index + 1].data.date, "en"));

    return {
      ...post,
      views,
      formattedViews: formatNumber(views, "en"),
      formattedDate: formattedDateStr,
      showDate,
    };
  })
);
---

<Layout title={t.blog.pageTitle}>
  <div class="flex flex-col gap-6">
    <ul class="flex flex-col">
      {
                enhancedPosts.map((post) => (
                    <li>
                        <a
                            aria-label={`Read blog post: ${post.data.title}`}
                            class="group flex flex-col items-start gap-1 rounded-sm py-4 transition-all hover:bg-muted/50 active:scale-95 md:flex-row md:items-center md:gap-4 md:p-4"
                            href={`/blog/${post.slug}`}
                        >
                            <div class="flex items-center gap-2 text-muted-foreground">
                                <span
                                    class={cn(
                                        "shrink-0 font-light text-muted-foreground text-xs md:w-20",
                                        { "opacity-0": !post.showDate },
                                    )}
                                >
                                    {post.formattedDate}
                                </span>
                            </div>

                            <span class="flex-1 font-medium text-base text-foreground">
                                {post.data.title}
                            </span>

                            {post.views > 0 && (
                                <span class="hidden text-right font-light text-muted-foreground text-xs md:flex">
                                    {post.formattedViews}{" "}
                                    {post.views > 1
                                        ? t.blog.views
                                        : t.blog.view}
                                </span>
                            )}
                        </a>
                    </li>
                ))
            }
    </ul>
  </div>
</Layout>
