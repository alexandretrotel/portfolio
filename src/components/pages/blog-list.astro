---
/* eslint-disable jest/require-hook */
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import type { BlogCollection } from "@/content.config";
import Layout from "@/layouts/main.astro";
import { cn } from "@/lib/utils";

const pageTitle = "Blog | atrtde";
const pageDescription = "Thoughts, experiments, and in-progress stories.";

const formatDate = (date: Date): string =>
  date.toLocaleDateString("en-US", {
    day: "numeric",
    month: "short",
    year: "numeric",
  });

const readPostLabel = (title: string) => `Read blog post: ${title}`;

let posts: CollectionEntry<BlogCollection>[] = [];
try {
  posts = await getCollection("blog");
} catch {
  posts = [];
}

const sortedPosts = posts.toSorted(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);

const enhancedPosts = sortedPosts.map((post, index, arr) => {
  const formattedDate = formatDate(post.data.date);

  const showDate =
    index === 0 ||
    index === arr.length - 1 ||
    (arr[index + 1] &&
      formattedDate !== formatDate(arr[index + 1].data.date));

  return {
    ...post,
    formattedDate,
    showDate,
  };
});
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="flex flex-col gap-6">
    <ul class="flex flex-col">
      {enhancedPosts.map((post) => (
          <li>
            <a
              aria-label={readPostLabel(post.data.title)}
              class="group flex flex-col items-start gap-1 rounded-sm py-4 transition-all hover:bg-muted/50 active:scale-95 md:flex-row md:items-center md:gap-4 md:p-4"
              href={`/blog/${post.id}`}
            >
              <div class="flex items-center gap-2 text-muted-foreground">
                <span
                  class={cn(
                    "shrink-0 font-light text-muted-foreground text-xs md:w-20",
                    { "opacity-0": !post.showDate }
                  )}
                >
                  {post.formattedDate}
                </span>
              </div>

              <span class="flex-1 font-medium text-base text-foreground">
                {post.data.title}
              </span>
            </a>
          </li>
        ))}
    </ul>
  </div>
</Layout>
